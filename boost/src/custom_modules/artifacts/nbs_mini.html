<style>body{margin:0;font-family:Arial,sans-serif;overflow:hidden;background:#222}svg{width:100vw;height:100vh;display:block}.node{cursor:pointer}R .link{stroke-opacity:0.7}.node text{pointer-events:none;font-size:10px;font-weight:700;opacity:1}#tracker{font-size:1.5rem;max-height:12rem;max-width:60rem;overflow-y:auto;scrollbar-color:rgba(255,255,255,0.2) transparent;scrollbar-width:thin}#tracker>span{display:inline-block;padding:.125rem;margin:.125rem;border-radius:.25rem;background-color:transparent;transition:background-color .3s ease}#legend{position:absolute;bottom:1rem;left:1rem;right:1rem;display:flex;flex-direction:column;background:rgba(0,0,0,.25);padding:1rem;gap:1rem;border-radius:1rem;font-size:14px;backdrop-filter:blur(12px)}#legend>.items{flex:1;display:flex;flex-direction:row;gap:.5rem}#legend>.items>*{width:1rem;height:1rem;border-radius:1rem}</style><svg id="visualisation"></svg><section id="legend"><section class="items"></section><section id="tracker"></section></section><script type="module">import*as d3 from"https://cdn.jsdelivr.net/npm/d3@7/+esm";let svg,simulation,link,node,width,height,container,linksGroup,nodesGroup,xScaleUpper=100,xScale=d3.scaleTime().range([0,xScaleUpper]),colors=d3.scaleOrdinal(d3.schemeObservable10);const nodes=[],links=[];function initializeVisualization(){svg=d3.select("#visualisation").attr("width","100%").attr("height","100%");const t=d3.zoom().scaleExtent([.1,4]).on("zoom",t=>{container.attr("transform",t.transform)});svg.call(t),container=svg.append("g").attr("class","container"),linksGroup=container.append("g").attr("class","links"),nodesGroup=container.append("g").attr("class","nodes");const e=svg.append("defs"),n=e.append("filter").attr("id","glow").attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%"),o=e.append("filter").attr("id","glowStronger").attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%");n.append("feGaussianBlur").attr("stdDeviation","2").attr("result","coloredBlur");const a=n.append("feMerge");a.append("feMergeNode").attr("in","coloredBlur"),a.append("feMergeNode").attr("in","SourceGraphic"),o.append("feGaussianBlur").attr("stdDeviation","6").attr("result","coloredBlur");const r=o.append("feMerge");r.append("feMergeNode").attr("in","coloredBlur"),r.append("feMergeNode").attr("in","SourceGraphic"),updateDimensions(),simulation=d3.forceSimulation().force("link",d3.forceLink().id(t=>t.id).distance(120)).force("charge",d3.forceManyBody().strength(-250)).force("y",d3.forceY(height/2).strength(.03)).force("collide",d3.forceCollide().radius(32)),simulation.on("tick",ticked),window.addEventListener("resize",()=>{updateDimensions(),simulation.force("center",d3.forceCenter(width/2,height/2)),updateXScale(),simulation.alpha(.5).restart()})}function updateDimensions(){width=window.innerWidth,height=window.innerHeight,svg.attr("width",width).attr("height",height)}const formatTime=d3.timeFormat("%H:%M:%S");function addNode(t){const e=new Date;if("string"==typeof t&&(t={id:t,label:t,timestamp:e,timeStr:formatTime(e),x:width/2,y:height/2}),nodes.find(e=>e.id===t.id))return;const n={id:Math.random().toString(16).replace(".",""),label:t.label||t.id||"Node",category:t.category||"relevant_concepts",timestamp:e,timeStr:formatTime(e),x:width/2,y:height/2,...t};return nodes.push(n),updateVisualization(),n}const highlightedNodes=new Set;function linkNodes(t,e){const n=nodes.find(e=>e.id===t),o=nodes.find(t=>t.id===e);if(!n||!o)return;if(links.some(n=>n.source===t&&n.target===e||n.source===e&&n.target===t))return;const a={source:t,target:e};return links.push(a),highlightedNodes.add(t),highlightedNodes.add(e),updateVisualization(),a}function updateXScale(){if(!nodes.length)return;const t=d3.min(nodes,t=>t.timestamp),e=d3.max(nodes,t=>t.timestamp);xScale.domain(t===e?[d3.timeMinute.offset(t,-1),d3.timeMinute.offset(e,1)]:[t,e]),simulation.force("xTime",d3.forceX(t=>xScale(t.timestamp)).strength(.4))}function nodeWidth(t){return 8*Math.max(t.label.length,t.timeStr.length)+20}function updateVisualization(){updateXScale(),link=linksGroup.selectAll("line").data(links,t=>`${t.source.id||t.source}-${t.target.id||t.target}`),link.exit().remove(),link=link.enter().append("line").attr("class","link").attr("stroke","#999").attr("stroke-width",2).merge(link),node=nodesGroup.selectAll(".node").data(nodes,t=>t.id),node.exit().remove();const t=node.enter().append("g").attr("class","node").call(drag(simulation)).append("g");t.append("rect").attr("x",t=>-nodeWidth(t)/2).attr("y",-18).attr("width",t=>nodeWidth(t)).attr("height",24).attr("rx",12).attr("ry",12).style("fill",t=>"#eee").style("stroke","#e5e7eb").style("stroke-width",2).style("filter","url(#glow)").attr("transform","scale(0)").transition().duration(600).ease(d3.easeElastic.period(.75)).attr("transform","scale(1)"),t.append("circle").attr("r",8).attr("cx",t=>.5*-nodeWidth(t)+12).attr("cy",-6).style("fill",t=>colors(t.category)).attr("transform","scale(0)").transition().duration(600).ease(d3.easeElastic.period(.75)).attr("transform","scale(1)"),t.append("text").attr("dy",-2).attr("text-anchor","middle").text(t=>t.label).style("fill","#2d2d2d").style("font-weight","600").style("font-size","12px").attr("transform","scale(0)").transition().duration(600).ease(d3.easeElastic.period(.75)).attr("transform","scale(1)"),node=t.merge(node),node.each(function(t){const e=highlightedNodes.has(t.id);d3.select(this).selectAll("rect").transition().duration(300).attr("transform","scale(1)").style("filter",e?"url(#glowStronger)":"url(#glow)"),d3.select(this).selectAll("text").transition().duration(300).attr("transform","scale(1)")}),simulation.nodes(nodes),simulation.force("link").links(links),simulation.alpha(.2).restart(),nodesGroup.raise()}function drag(t){return d3.drag().on("start",function(e){e.active||t.alphaTarget(.3).restart(),e.subject.fx=e.subject.x,e.subject.fy=e.subject.y}).on("drag",function(t){t.subject.fx=t.x,t.subject.fy=t.y}).on("end",function(e){e.active||t.alphaTarget(0),e.subject.fx=null,e.subject.fy=null})}function ticked(){container.selectAll(".link").attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),container.selectAll(".node").attr("transform",t=>`translate(${t.x}, ${t.y})`)}const handlers={"boost.listener.event":handleBoostEvent,"chat.completion.chunk":handleCompletionChunk,"boost.node":({data:t})=>addNode(t),"boost.nodes":({data:t})=>{const{nodes:e}=t;xScaleUpper+=200,xScale.range([100,xScaleUpper]),e.forEach(t=>addNode(t))},"boost.node.choice":({data:t})=>{const{node:e}=t,n=document.getElementById("tracker"),o=document.createElement("span");o.textContent=e.label,o.style.backgroundColor=colors(e.category),n.appendChild(o)},"boost.linked_concepts":({data:t})=>{const{concepts:e}=t;e.reduce((t,e)=>(t&&linkNodes(t,e),e),null)},"boost.nbs.prompts":({data:t})=>{const{prompts:e}=t,n=Object.entries(e).map(([t,e])=>({label:t,prompt:e,color:colors(t)}));d3.select("#legend > .items").selectAll("div").data(n).join("div").attr("title",t=>`${t.label.toLocaleUpperCase()}\n${t.prompt}`).style("background-color",t=>t.color).style("margin","5px 0").style("font-size","14px")}};function processChunk(t){try{const e=JSON.parse(t.replace(/data: /,"")),n=e.object,o=handlers[n];o&&o(e)}catch(t){console.error("Error processing chunk:",t)}}function handleCompletionChunk(){}function handleBoostEvent(t){const{event:e}=t,n=handlers[e];n&&n(t)}async function startListening(){try{const t="<<listener_id>>",e="<<boost_public_url>>",n=await fetch(`${e}/events/${t}`,{headers:{Authorization:"Bearer sk-boost"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=n.body.getReader();for(;;){const{done:t,value:e}=await o.read();if(t)break;const n=(new TextDecoder).decode(e).split("\n\n");for(const t of n)t.trim()&&processChunk(t)}}catch(t){console.error("Error connecting to event stream:",t)}}document.addEventListener("DOMContentLoaded",()=>{initializeVisualization(),startListening(),window.addNode=addNode,window.linkNodes=linkNodes})</script>