<style>body{margin:0;font-family:Arial,sans-serif;overflow:hidden;background:#222}svg{width:100vw;height:100vh;display:block}.node{cursor:pointer}.link{stroke-opacity:0.7}.node text{pointer-events:none;font-size:10px;fill:#fff;font-weight:700;text-shadow:0 0 3px #000;opacity:1}</style><script type="module">import*as d3 from"https://cdn.jsdelivr.net/npm/d3@7/+esm";const width=window.innerWidth,height=window.innerHeight,svg=d3.select("body").append("svg").attr("width",width).attr("height",height),g=svg.append("g"),zoom=d3.zoom().scaleExtent([.1,10]).on("zoom",(e=>{g.attr("transform",e.transform)}));svg.call(zoom);let nodes=[],links=[],lastNodeId=null;const colorScale=d3.scaleOrdinal(d3.schemeObservable10),link=g.append("g").attr("class","links").selectAll("line"),node=g.append("g").attr("class","nodes").selectAll("g");function getNodeDegree(e){return links.filter((t=>t.source.id===e||t.target.id===e)).length}const simulation=d3.forceSimulation().force("link",d3.forceLink().id((e=>e.id)).distance((e=>{const t=getNodeDegree(e.source.id),o=getNodeDegree(e.target.id);return 30+10*Math.sqrt(t+o)}))).force("charge",d3.forceManyBody().strength((e=>-100-30*getNodeDegree(e.id)-5*e.radius))).force("center",d3.forceCenter(width/2,height/2)).force("collision",d3.forceCollide().radius((e=>e.radius+10))).force("x",d3.forceX(width/2).strength(.05)).force("y",d3.forceY(height/2).strength(.05));function updateGraph(){nodes.forEach((e=>{const t=Math.floor(e.radius/5);e.group=t,e.connections=getNodeDegree(e.id)}));const e=g.select(".links").selectAll("line").data(links,(e=>`${e.source.id}-${e.target.id}`));e.exit().remove();e.enter().append("line").attr("class","link").attr("stroke-width",(e=>Math.max(1.5,Math.min(4,(e.source.radius+e.target.radius)/15)))).attr("stroke",(e=>"object"==typeof e.source&&"object"==typeof e.target?d3.interpolateRgb(d3.color(colorScale(e.source.group)),d3.color(colorScale(e.target.group)))(.5):"#999"));const t=g.select(".nodes").selectAll("g").data(nodes,(e=>e.id));t.exit().remove();const o=t.enter().append("g").attr("class","node").call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended));o.append("circle").attr("r",(e=>e.radius)).attr("fill",(e=>{const t=d3.color(colorScale(e.group)),o=Math.min(1,.7+e.connections/20);return t.opacity=o,t})),o.append("text").attr("dy",(e=>e.radius+10)).attr("text-anchor","middle").text((e=>e.id)),t.select("circle").attr("r",(e=>e.radius)).attr("fill",(e=>{const t=d3.color(colorScale(e.group)),o=Math.min(1,.7+e.connections/20);return t.opacity=o,t})),simulation.nodes(nodes),simulation.force("link").links(links),simulation.alpha(1).restart()}function dragstarted(e,t){e.active||simulation.alphaTarget(.3).restart(),t.fx=t.x,t.fy=t.y}function dragged(e,t){t.fx=e.x,t.fy=e.y}function dragended(e,t){e.active||simulation.alphaTarget(0),t.fx=null,t.fy=null}function addToken(e){if(!e||""===e.trim())return;let t=nodes.findIndex((t=>t.id===e));if(-1===t){const o={id:e,radius:10,index:nodes.length,connections:0};nodes.push(o),t=nodes.length-1}else nodes[t].radius+=5;if(null!==lastNodeId&&lastNodeId!==e){let t=links.find((t=>t.source.id===lastNodeId&&t.target.id===e||t.source.id===e&&t.target.id===lastNodeId));t?t.weight=(t.weight||1)+1:links.push({source:lastNodeId,target:e,weight:1})}lastNodeId=e,updateGraph()}simulation.on("tick",(()=>{g.selectAll(".link").attr("x1",(e=>e.source.x)).attr("y1",(e=>e.source.y)).attr("x2",(e=>e.target.x)).attr("y2",(e=>e.target.y)),g.selectAll(".node").attr("transform",(e=>`translate(${e.x},${e.y})`))}));const handlers={"boost.listener.event":handleBoostEvent,"chat.completion.chunk":handleCompletionChunk};function processChunk(e){try{const t=JSON.parse(e.replace(/data: /,"")),o=t.object,n=handlers[o];n&&(console.log("Processing chunk:",t),n(t))}catch(e){console.error("Error processing chunk:",e)}}function isDisplayedToken(e){const t=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","as","from","into","onto","upon","out","that","their","they","them","this","these","those","there","then","than","thus","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","shall","should","may","might","must","can","could","ought"]),o=e.trim().toLowerCase(),n=0===o.replace(/[`.,!?;:"'()\[\]{}\/\\\-_+=<>#\$\*]+$/g,"").length;return o.length>1&&!n&&!t.has(o)}function handleCompletionChunk(e){const t=getChunkContent(e);isDisplayedToken(t)&&addToken(t)}function handleBoostEvent(){}function getChunkContent(e){return e.choices.map((e=>e.delta.content)).join("\n")}async function startListening(){try{const e="<<listener_id>>",t=await fetch(`http://localhost:34131/events/${e}`,{headers:{Authorization:"Bearer sk-boost"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=t.body.getReader();for(;;){const{done:e,value:t}=await o.read();if(e){console.log("Stream complete");break}try{const e=(new TextDecoder).decode(t).split("\n\n");for(const t of e)t.trim()&&processChunk(t)}catch(e){console.error("Error processing data:",e)}}}catch(e){console.error("Error connecting to event stream:",e)}}document.addEventListener("DOMContentLoaded",(()=>{startListening()}))</script>