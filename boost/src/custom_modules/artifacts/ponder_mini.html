<style>body{margin:0;font-family:Arial,sans-serif;overflow:hidden;background:#222}svg{width:100vw;height:100vh;display:block}.node{cursor:pointer}.link{stroke-opacity:0.7}.node text{pointer-events:none;font-size:10px;fill:#fff;font-weight:700;text-shadow:0 0 3px #000;opacity:1}</style><script type="module">import*as d3 from"https://cdn.jsdelivr.net/npm/d3@7/+esm";let svg,simulation,link,node,width,height,container,linksGroup,nodesGroup;const nodes=[],links=[],initialConcepts={},colorMap={relevant_concepts:"#dedede",orthogonal_concepts:"#6366f1",user_needs:"#10b981",assistant_needs:"#f59e0b",strategies:"#f97316"};function initializeVisualization(){svg=d3.select("body").append("svg").attr("width","100%").attr("height","100%");const t=d3.zoom().scaleExtent([.1,4]).on("zoom",(t=>{container.attr("transform",t.transform)}));svg.call(t),container=svg.append("g").attr("class","container"),linksGroup=container.append("g").attr("class","links"),nodesGroup=container.append("g").attr("class","nodes");const e=svg.append("defs"),n=e.append("filter").attr("id","glow").attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%"),o=e.append("filter").attr("id","glowStronger").attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%");n.append("feGaussianBlur").attr("stdDeviation","2").attr("result","coloredBlur");const r=n.append("feMerge");r.append("feMergeNode").attr("in","coloredBlur"),r.append("feMergeNode").attr("in","SourceGraphic"),o.append("feGaussianBlur").attr("stdDeviation","6").attr("result","coloredBlur");const a=o.append("feMerge");a.append("feMergeNode").attr("in","coloredBlur"),a.append("feMergeNode").attr("in","SourceGraphic"),updateDimensions(),simulation=d3.forceSimulation().force("link",d3.forceLink().id((t=>t.id)).distance(120)).force("charge",d3.forceManyBody().strength(-250)).force("x",d3.forceX(width/2).strength(.03)).force("y",d3.forceY(height/2).strength(.03)).force("collide",d3.forceCollide().radius(32)),populateInitialData(),window.addEventListener("resize",(()=>{updateDimensions(),simulation.force("center",d3.forceCenter(width/2,height/2)),simulation.alpha(.5).restart()}))}function updateDimensions(){width=window.innerWidth,height=window.innerHeight,svg.attr("width",width).attr("height",height)}function populateInitialData(){Object.entries(initialConcepts).forEach((([t,e])=>{e.forEach((e=>{addNode(e,t)}))}))}function addNode(t,e="relevant_concepts"){if(nodes.find((e=>e.id===t)))return void console.log(`Node ${t} already exists`);const n={id:t,label:t,category:e,x:width/2,y:height/2};return nodes.push(n),updateVisualization(),n}const highlightedNodes=new Set;function linkNodes(t,e){const n=nodes.find((e=>e.id===t)),o=nodes.find((t=>t.id===e));if(!n||!o)throw new Error(`Cannot link: one or both nodes don't exist (${t}, ${e})`);if(links.some((n=>n.source===t&&n.target===e||n.source===e&&n.target===t)))return void console.log(`Link between ${t} and ${e} already exists`);const r={source:t,target:e};return links.push(r),highlightedNodes.add(t),highlightedNodes.add(e),updateVisualization(),r}function updateVisualization(){link=linksGroup.selectAll("line").data(links,(t=>`${t.source.id||t.source}-${t.target.id||t.target}`)),link.exit().remove();const t=link.enter().append("line").attr("class","link").attr("stroke","#999").attr("stroke-width",2);link=t.merge(link),node=nodesGroup.selectAll(".node").data(nodes,(t=>t.id)),node.exit().remove();const e=node.enter().append("g").attr("class","node").call(drag(simulation));e.append("rect").attr("x",(t=>4*-t.label.length-10)).attr("y",-12).attr("width",(t=>8*t.label.length+20)).attr("height",24).attr("rx",12).attr("ry",12).style("fill",(t=>colorMap[t.category]||"#6b7280")).style("stroke","#e5e7eb").style("stroke-width",2).style("filter","url(#glow)").attr("transform","scale(0)").transition().duration(600).ease(d3.easeElastic.period(.75)).attr("transform","scale(1)"),e.append("text").attr("dy",4).attr("text-anchor","middle").text((t=>t.label)).style("fill","#2d2d2d").style("font-weight","600").style("font-size","14px").style("text-shadow","0 1px 2px rgba(0,0,0,0.3)").attr("transform","scale(0)").transition().duration(600).ease(d3.easeElastic.period(.75)).attr("transform","scale(1)"),node=e.merge(node),node.each((function(t){const e=highlightedNodes.has(t.id);d3.select(this).select("rect").transition().duration(300).attr("transform",e?"scale(1.25)":"scale(1)").style("filter",e?"url(#glowStronger)":"url(#glow)"),d3.select(this).select("text").transition().duration(300).attr("transform",e?"scale(1.15)":"scale(1)")})),simulation.nodes(nodes),simulation.force("link").links(links),simulation.alpha(.2).restart(),nodesGroup.raise()}function drag(t){return d3.drag().on("start",(function(e){e.active||t.alphaTarget(.3).restart(),e.subject.fx=e.subject.x,e.subject.fy=e.subject.y})).on("drag",(function(t){t.subject.fx=t.x,t.subject.fy=t.y})).on("end",(function(e){e.active||t.alphaTarget(0),e.subject.fx=null,e.subject.fy=null}))}function ticked(){container.selectAll(".link").attr("x1",(t=>t.source.x)).attr("y1",(t=>t.source.y)).attr("x2",(t=>t.target.x)).attr("y2",(t=>t.target.y)),container.selectAll(".node").attr("transform",(t=>`translate(${t.x}, ${t.y})`))}const handlers={"boost.listener.event":handleBoostEvent,"chat.completion.chunk":handleCompletionChunk,"boost.concept":function({data:t}){addNode(t.concept,"relevant_concepts")},"boost.linked_concepts":function({data:t}){const{concepts:e}=t;e.reduce(((t,e)=>(t&&linkNodes(t,e),e)),null)}};function processChunk(t){try{const e=JSON.parse(t.replace(/data: /,"")),n=e.object,o=handlers[n];o&&(console.log("Processing chunk:",e),o(e))}catch(t){console.error("Error processing chunk:",t)}}function handleCompletionChunk(t){}function handleBoostEvent(t){const{event:e}=t,n=handlers[e];n?(console.log("Handling boost event:",e),n(t)):console.warn(`No handler for event: ${e}`)}function getChunkContent(t){return t.choices.map((t=>t.delta.content)).join("\n")}async function startListening(){try{const t="<<listener_id>>",e="<<boost_public_url>>",n=await fetch(`${e}/events/${t}`,{headers:{Authorization:"Bearer sk-boost"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=n.body.getReader();for(;;){const{done:t,value:e}=await o.read();if(t){console.log("Stream complete");break}try{const t=(new TextDecoder).decode(e).split("\n\n");for(const e of t)e.trim()&&processChunk(e)}catch(t){console.error("Error processing data:",t)}}}catch(t){console.error("Error connecting to event stream:",t)}}document.addEventListener("DOMContentLoaded",(()=>{initializeVisualization(),simulation.on("tick",ticked),startListening(),window.addNode=addNode,window.linkNodes=linkNodes}))</script>