# Harbor Service Configuration for Dify2
# This file configures how Harbor manages this service
# This is the SINGLE SOURCE OF TRUTH - no separate compose.dify2.yml needed

# Upstream compose transformation
# Allows using stock Docker Compose files with automatic Harbor integration
upstream:
  # Path to stock compose file (relative to this directory)
  source: ./upstream/docker/docker-compose.yaml

  # Namespace for isolation
  # Creates internal network where services use original names (api, db, redis)
  # Service names in merged compose are prefixed (dify2-api, dify2-web)
  # Original names available as aliases on internal network
  namespace: dify2

  # Services to include/exclude from stock compose
  services:
    exclude:
      - nginx
      - certbot

  # Services exposed on harbor-network
  # - Simple string: uses original name (matches upstream)
  # - Object {service: alias}: uses custom alias (e.g., for conflict avoidance)
  # Other services stay internal-only (no conflicts with other Harbor services)
  expose:
    - api                    # exposed as "api" (original name)
    - web                    # exposed as "web" (original name)
    # - web: dify2-web       # example: prefixed alias when conflict expected

  # Static overrides (always applied)
  # Keys are ORIGINAL service names, applied to prefixed services
  overrides:
    web:
      ports:
        - ${HARBOR_DIFY2_HOST_PORT:-3001}:3000

  # Cross-service overlays (applied when other Harbor services are active)
  # Structure: <other_service>: <target_service>: <compose_properties>
  overlays:
    # When ollama is running, configure api to use it
    ollama:
      api:
        environment:
          - OPENAI_API_BASE=http://${HARBOR_CONTAINER_PREFIX}.ollama:11434/v1
    # When litellm is running, configure api to use it instead
    litellm:
      api:
        environment:
          - OPENAI_API_BASE=http://${HARBOR_CONTAINER_PREFIX}.litellm:4000/v1
    # AND logic: when BOTH ollama AND langfuse are running
    # [ollama, langfuse]:
    #   api:
    #     environment:
    #       - LANGFUSE_ENABLED=true

# Future sections (not yet implemented):
# metadata:
#   tags: [backend, api]
#   wikiUrl: https://github.com/av/harbor/wiki/dify2
